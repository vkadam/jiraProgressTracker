/*! Jira Progress Tracker - v0.0.1 - 2013-02-21
* https://github.com/vkadam/jiraProgressTracker
* Copyright (c) 2013 Vishal Kadam; Licensed MIT */
var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=Base64._utf8_encode(e);while(f<e.length)n=e.charCodeAt(f++),r=e.charCodeAt(f++),i=e.charCodeAt(f++),s=n>>2,o=(n&3)<<4|r>>4,u=(r&15)<<2|i>>6,a=i&63,isNaN(r)?u=a=64:isNaN(i)&&(a=64),t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a);return t},decode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length)s=this._keyStr.indexOf(e.charAt(f++)),o=this._keyStr.indexOf(e.charAt(f++)),u=this._keyStr.indexOf(e.charAt(f++)),a=this._keyStr.indexOf(e.charAt(f++)),n=s<<2|o>>4,r=(o&15)<<4|u>>2,i=(u&3)<<6|a,t+=String.fromCharCode(n),u!==64&&(t+=String.fromCharCode(r)),a!==64&&(t+=String.fromCharCode(i));return t=Base64._utf8_decode(t),t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t},_utf8_decode:function(e){var t="",n=0,r=0,i=0;while(n<e.length)r=e.charCodeAt(n),r<128?(t+=String.fromCharCode(r),n++):r>191&&r<224?(i=e.charCodeAt(n+1),t+=String.fromCharCode((r&31)<<6|i&63),n+=2):(i=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((r&15)<<12|(i&63)<<6|c3&63),n+=3);return t}};(function(e,t){function u(e,n){var r=t.Deferred(),i={};r.promise(i);var s=this.validate(e);return t.extend(i,{errors:s.errorMap}),s.valid()&&n.apply(this,[r]),i}var n=function(e){this.parse(e)};n.getValue=function(e,t){var n=e;for(var r=0,i=t.length;r<i-1;r++)n=n[t[r]];return n?n[t[i-1]]:null},n.fields={Project:["fields","project","key"],Key:["key"],"Issue Type":["fields","issuetype","name"],Summary:["fields","summary"],Status:["fields","status","name"],Assignee:["fields","assignee","displayName"],Reporter:["fields","reporter","displayName"],Priority:["fields","priority","name"],Resolution:["fields","resolution"],"Created Date":["fields","created"],"Due Date":["fields","duedate"],"Fix Version":["fields","fixVersions"],"Resolution Date":["fields","resolutiondate"],"Component/s":["fields","components"],Labels:["fields","labels"],Points:["fields","customfield_10792"],Team:["fields","customfield_11261","value"],"Work Stream":["fields","customfield_12544","value"],"Epic/Theme":["fields","customfield_10850"],Feature:["fields","customfield_12545"]},n.prototype.parse=function(e){var r=this;return e&&t.each(n.fields,function(t,i){r[t]=n.getValue(e,i)}),this},n.prototype.toArray=function(){var e=this,r=[],i;return t.each(n.fields,function(n){i=e[n],"Fix Version"!==n&&"Component/s"!==n||null===i?("Labels"===n||"Epic/Theme"===n||"Feature"===n)&&null!==i&&(i=[],t.each(e[n],function(e,t){i.push(t)}),i=i.join("\n")):(i=[],t.each(e[n],function(e,t){i.push(t.name)}),i=i.join("\n")),r.push(i)}),r};var r={releaseId:""},i=function(){this.activeRelease=null},s=new i,o={heighlighter:function(e,n){t(e).parents(".control-group").addClass(n)},unheighlighter:function(e,n){t(e).parents(".control-group").removeClass(n)},addValidatorType:function(e,n){var r={highlight:this.heighlighter,unhighlight:this.unheighlighter};this[e]=t.extend(r,n)}};o.addValidatorType.call(o,"LOAD_RELEASE",{rules:{releaseId:"required"},messages:{releaseId:"Release id is required"}}),o.addValidatorType.call(o,"CREATE_BASELINE",{rules:{releaseTitle:"required",jiraUseId:"required",jiraPassword:"required",jiraJQL:"required",snapshotTitle:"required"},messages:{releaseTitle:"Release title is required",jiraUseId:"Jira user name is required",jiraPassword:"Jira password is required",jiraJQL:"Jira JQL is required",snapshotTitle:"Snapshot title is required"}}),o.addValidatorType.call(o,"CREATE_SNAPSHOT",{rules:{releaseId:"required",jiraUseId:"required",jiraPassword:"required",jiraJQL:"required",jiraMaxResults:"required",snapshotTitle:"required"},messages:{releaseId:"Release is not loaded",jiraUseId:"Jira user name is required",jiraPassword:"Jira password is required",jiraJQL:"Jira JQL is required",jiraMaxResults:"Value of max result from is required",snapshotTitle:"Snapshot title is required"}}),i.prototype.validate=function(e){var n=t(".jira-tracker"),r=t.data(n[0],"validator");r&&r.reset&&(t.each(r.errors(),function(e,t){r.settings.unhighlight.call(r,t,r.settings.errorClass,r.settings.validClass)}),r.reset()),t.data(n[0],"validator",null);var i=n.validate(o[e]);return i.form(),i},i.prototype.init=function(e){var n=this;chrome.storage.sync.get("JiraTracker",function(i){t.extend(r,i.JiraTracker);if(r.releaseId&&r.releaseId.length>0)return n.loadRelease(e,r.releaseId)})},i.prototype.loadRelease=function(e,n){return n&&t("#releaseId").val(n),n=t("#releaseId").val(),u.call(this,"LOAD_RELEASE",function(e){e.done(this.onReleaseChange),GSLoader.loadSpreadsheet({context:this,id:n}).done(function(t){e.resolveWith(this,[t])})})},i.prototype.createBaseline=function(e,n){var r=this;return n&&t("#releaseTitle").val(n),n=t("#releaseTitle").val(),u.call(r,"CREATE_BASELINE",function(i){GSLoader.createSpreadsheet({context:r,title:n}).done(r.onReleaseChange).done(function(){var n=r.activeRelease.worksheets[0].rename("Setup");baselineReq=r.createSnapshot(e,"Baseline"),t.when(n,baselineReq).done(function(){i.resolveWith(r,[r.activeRelease])})})})},i.prototype.onReleaseChange=function(e){this.activeRelease=e,t("#releaseId").val(this.activeRelease.id),t("#releaseTitle").val(this.activeRelease.title),chrome.storage.sync.set({JiraTracker:{releaseId:this.activeRelease.id}})},i.prototype.createSnapshot=function(e,r){var i=this;return u.call(this,"CREATE_SNAPSHOT",function(e){var s=Base64.encode(t("#jiraUseId").val()+":"+t("#jiraPassword").val());t.ajax({url:"http://jira.cengage.com/rest/api/2/search",data:{maxResults:t("#jiraMaxResults").val(),jql:t("#jiraJQL").val()},headers:{Authorization:"Basic "+s}}).done(function(s){typeof s=="string"&&(s=JSON.parse(s));var o=[];t.each(n.fields,function(e){o.push(e)});var u=[],a;t.each(s.issues,function(e,t){a=new n(t),u.push(a.toArray())}),i.activeRelease.createWorksheet({title:r||t("#snapshotTitle").val(),headers:o,rowData:u,rows:u.length+1,cols:o.length}).done(function(t){e.resolveWith(this,[t])})})})},t.extend(e,{JiraTracker:s})})(window,jQuery),$(function(){JiraTracker.init(),$(".load-release").click($.proxy(JiraTracker.loadRelease,JiraTracker)),$(".create-release").click($.proxy(JiraTracker.createBaseline,JiraTracker)),$(".create-snapshot").click($.proxy(JiraTracker.createSnapshot,JiraTracker))}),window.googleDriveClientLoaded=function(){GSLoader.enableLog().auth.setClientId("1074663392007.apps.googleusercontent.com").onLoad(GSLoader.drive.load,GSLoader.drive)};