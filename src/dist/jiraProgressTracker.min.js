/* Jira Progress Tracker - v0.0.2rc - 2013-02-22
* https://github.com/vkadam/jiraProgressTracker
* Copyright (c) 2013 Vishal Kadam; Licensed MIT */
var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var r,a,t,i,s,o,n,l="",d=0;for(e=Base64._utf8_encode(e);e.length>d;)r=e.charCodeAt(d++),a=e.charCodeAt(d++),t=e.charCodeAt(d++),i=r>>2,s=(3&r)<<4|a>>4,o=(15&a)<<2|t>>6,n=63&t,isNaN(a)?o=n=64:isNaN(t)&&(n=64),l=l+this._keyStr.charAt(i)+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(n);return l},decode:function(e){var r,a,t,i,s,o,n,l="",d=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");e.length>d;)i=this._keyStr.indexOf(e.charAt(d++)),s=this._keyStr.indexOf(e.charAt(d++)),o=this._keyStr.indexOf(e.charAt(d++)),n=this._keyStr.indexOf(e.charAt(d++)),r=i<<2|s>>4,a=(15&s)<<4|o>>2,t=(3&o)<<6|n,l+=String.fromCharCode(r),64!==o&&(l+=String.fromCharCode(a)),64!==n&&(l+=String.fromCharCode(t));return l=Base64._utf8_decode(l)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var r="",a=0;e.length>a;a++){var t=e.charCodeAt(a);128>t?r+=String.fromCharCode(t):t>127&&2048>t?(r+=String.fromCharCode(192|t>>6),r+=String.fromCharCode(128|63&t)):(r+=String.fromCharCode(224|t>>12),r+=String.fromCharCode(128|63&t>>6),r+=String.fromCharCode(128|63&t))}return r},_utf8_decode:function(e){for(var r="",a=0,t=0,i=0;e.length>a;)t=e.charCodeAt(a),128>t?(r+=String.fromCharCode(t),a++):t>191&&224>t?(i=e.charCodeAt(a+1),r+=String.fromCharCode((31&t)<<6|63&i),a+=2):(i=e.charCodeAt(a+1),c3=e.charCodeAt(a+2),r+=String.fromCharCode((15&t)<<12|(63&i)<<6|63&c3),a+=3);return r}};(function(e,r){function a(e,a){var t=r.Deferred(),i={};t.promise(i);var s=this.validate(e);return r.extend(i,{errors:s.errorMap}),s.valid()&&a.apply(this,[t]),i}var t=function(e){this.parse(e)};t.getValue=function(e,r){for(var a=e,t=0,i=r.length;i-1>t;t++)a=a[r[t]];return a?a[r[i-1]]:null},t.fields={Project:["fields","project","key"],Key:["key"],"Issue Type":["fields","issuetype","name"],Summary:["fields","summary"],Status:["fields","status","name"],Assignee:["fields","assignee","displayName"],Reporter:["fields","reporter","displayName"],Priority:["fields","priority","name"],Resolution:["fields","resolution"],"Created Date":["fields","created"],"Due Date":["fields","duedate"],"Fix Version":["fields","fixVersions"],"Resolution Date":["fields","resolutiondate"],"Component/s":["fields","components"],Labels:["fields","labels"],Points:["fields","customfield_10792"],Team:["fields","customfield_11261","value"],"Work Stream":["fields","customfield_12544","value"],"Epic/Theme":["fields","customfield_10850"],Feature:["fields","customfield_12545"]},t.prototype.parse=function(e){var a=this;return e&&r.each(t.fields,function(r,i){a[r]=t.getValue(e,i)}),this},t.prototype.toArray=function(){var e,a=this,i=[];return r.each(t.fields,function(t){e=a[t],"Fix Version"!==t&&"Component/s"!==t||null===e?"Labels"!==t&&"Epic/Theme"!==t&&"Feature"!==t||null===e||(e=[],r.each(a[t],function(r,a){e.push(a)}),e=e.join("\n")):(e=[],r.each(a[t],function(r,a){e.push(a.name)}),e=e.join("\n")),i.push(e)}),i};var i={releaseId:""},s=function(){this.activeRelease=null},o=new s,n={heighlighter:function(e,a){r(e).parents(".control-group").addClass(a)},unheighlighter:function(e,a){r(e).parents(".control-group").removeClass(a)},addValidatorType:function(e,a){var t={highlight:this.heighlighter,unhighlight:this.unheighlighter};this[e]=r.extend(t,a)}};n.addValidatorType.call(n,"LOAD_RELEASE",{rules:{releaseId:"required"},messages:{releaseId:"Release id is required"}}),n.addValidatorType.call(n,"CREATE_BASELINE",{rules:{releaseTitle:"required",jiraUserId:"required",jiraPassword:"required",jiraJQL:"required",snapshotTitle:"required"},messages:{releaseTitle:"Release title is required",jiraUserId:"Jira user name is required",jiraPassword:"Jira password is required",jiraJQL:"Jira JQL is required",snapshotTitle:"Snapshot title is required"}}),n.addValidatorType.call(n,"CREATE_SNAPSHOT",{rules:{releaseId:"required",jiraUserId:"required",jiraPassword:"required",jiraJQL:"required",jiraMaxResults:"required",snapshotTitle:"required"},messages:{releaseId:"Release is not loaded",jiraUserId:"Jira user name is required",jiraPassword:"Jira password is required",jiraJQL:"Jira JQL is required",jiraMaxResults:"Value of max result from is required",snapshotTitle:"Snapshot title is required"}}),s.prototype.validate=function(e){var a=r(".jira-tracker"),t=r.data(a[0],"validator");t&&t.reset&&(r.each(t.errors(),function(e,r){t.settings.unhighlight.call(t,r,t.settings.errorClass,t.settings.validClass)}),t.reset()),r.data(a[0],"validator",null);var i=a.validate(n[e]);return i.form(),i},s.prototype.init=function(e){var a=this;chrome.storage.sync.get("JiraTracker",function(t){return r.extend(i,t.JiraTracker),i.releaseId&&i.releaseId.length>0?a.loadRelease(e,i.releaseId):void 0})},s.prototype.loadRelease=function(e,t){return t&&r("#releaseId").val(t),t=r("#releaseId").val(),a.call(this,"LOAD_RELEASE",function(e){e.done(this.onReleaseChange),GSLoader.loadSpreadsheet({context:this,id:t}).done(function(r){e.resolveWith(this,[r])})})},s.prototype.createBaseline=function(e,t){var i=this;return t&&r("#releaseTitle").val(t),t=r("#releaseTitle").val(),a.call(i,"CREATE_BASELINE",function(a){GSLoader.log("Creating spreadsheet with title =",t),GSLoader.createSpreadsheet({context:i,title:t}).done(i.onReleaseChange).done(function(){var t=["Jira-User-Id",r("#jiraUserId").val()],s=Base64.encode(r("#jiraUserId").val()+":"+r("#jiraPassword").val()),o=["Jira-Basic-Authorization",s],n=["Jira-JQL",r("#jiraJQL").val()],l=[t,o,n],d=i.activeRelease.worksheets[0].rename("Setup"),c=i.createSnapshot(e,"Baseline");r.when(d,c).done(function(){GSLoader.log("Saving release settings into setup worksheet"),i.activeRelease.worksheets[0].addRows(l).done(function(){GSLoader.log("Release settings saved successfully"),a.resolveWith(i,[i.activeRelease])})})})})},s.prototype.onReleaseChange=function(e){this.activeRelease=e,r("#releaseId").val(this.activeRelease.id),r("#releaseTitle").val(this.activeRelease.title),chrome.storage.sync.set({JiraTracker:{releaseId:this.activeRelease.id}})},s.prototype.createSnapshot=function(e,i){var s=this;return a.call(this,"CREATE_SNAPSHOT",function(e){var a=Base64.encode(r("#jiraUserId").val()+":"+r("#jiraPassword").val());r.ajax({url:"http://jira.cengage.com/rest/api/2/search",data:{maxResults:r("#jiraMaxResults").val(),jql:r("#jiraJQL").val()},headers:{Authorization:"Basic "+a}}).done(function(a){"string"==typeof a&&(a=JSON.parse(a));var o=[];r.each(t.fields,function(e){o.push(e)});var n,l=[];r.each(a.issues,function(e,r){n=new t(r),l.push(n.toArray())}),s.activeRelease.createWorksheet({title:i||r("#snapshotTitle").val(),headers:o,rowData:l,rows:l.length+1,cols:o.length}).done(function(r){e.resolveWith(this,[r])})})})},r.extend(e,{JiraTracker:o})})(window,jQuery),$(function(){JiraTracker.init(),$(".load-release").click($.proxy(JiraTracker.loadRelease,JiraTracker)),$(".create-release").click($.proxy(JiraTracker.createBaseline,JiraTracker)),$(".create-snapshot").click($.proxy(JiraTracker.createSnapshot,JiraTracker))}),window.googleDriveClientLoaded=function(){GSLoader.enableLog().auth.setClientId("1074663392007.apps.googleusercontent.com").onLoad(GSLoader.drive.load,GSLoader.drive)};